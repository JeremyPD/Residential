<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prueba de Carga Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      background: #f8f9ff;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-area.dragover {
      border-color: #28a745;
      background: #e8f5e9;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .upload-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 15px;
      transition: transform 0.2s;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
    }

    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input[type="file"] {
      display: none;
    }

    .token-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      margin-top: 10px;
    }

    .token-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .info-box {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 13px;
    }

    .columns-detected {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .column-badge {
      background: #e9ecef;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }

    .column-badge.required {
      background: #28a745;
      color: white;
    }

    .column-badge.missing {
      background: #dc3545;
      color: white;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
    }

    .message.success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }

    .message.error {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }

    .message.warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .message.info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 13px;
    }

    .data-table th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: #f8f9ff;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .download-template-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s;
    }

    .download-template-btn:hover {
      transform: translateY(-2px);
    }

    .full-width-card {
      grid-column: 1 / -1;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-box {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß™ Probador de Carga Excel - Sistema de Casas</h1>
      <p class="subtitle">Valida tu archivo Excel antes de subirlo al sistema real</p>
    </div>

    <div class="main-content">
      <div class="card">
        <h2>
          <span>üìÇ</span>
          1. Subir Archivo Excel
        </h2>
        
        <button class="download-template-btn" onclick="downloadTemplate()">
          üì• Descargar Plantilla V√°lida
        </button>

        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÑ</div>
          <p><strong>Arrastra tu archivo aqu√≠</strong></p>
          <p style="font-size: 14px; color: #666; margin-top: 10px;">o</p>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            Seleccionar archivo
          </button>
          <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
          <p style="font-size: 12px; color: #999; margin-top: 15px;">
            Formatos: .xlsx, .xls | M√°x: 5MB
          </p>
        </div>

        <div id="fileInfo"></div>
      </div>

      <div class="card">
        <h2>
          <span>üîë</span>
          2. Token de Autenticaci√≥n (Opcional)
        </h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
          Si tienes un token, p√©galo aqu√≠ para probar la subida real al backend:
        </p>
        <input 
          type="text" 
          id="tokenInput" 
          class="token-input" 
          placeholder="Bearer tu_token_aqui..."
        >
        <div class="info-box">
          üí° <strong>Sin token:</strong> Solo validaremos la estructura del Excel<br>
          üîê <strong>Con token:</strong> Intentaremos subirlo al backend real
        </div>
      </div>
    </div>

    <div class="card full-width-card" id="resultsCard" style="display: none;">
      <h2>
        <span>üìä</span>
        3. Resultados de la Validaci√≥n
      </h2>
      <div id="results"></div>
    </div>

    <div class="card full-width-card" id="dataPreviewCard" style="display: none;">
      <h2>
        <span>üëÅÔ∏è</span>
        Vista Previa de Datos
      </h2>
      <div id="dataPreview"></div>
    </div>
  </div>

  <script>
    let excelData = null;
    let currentFile = null;

    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      currentFile = file;
      
      // Validar tama√±o
      if (file.size > 5 * 1024 * 1024) {
        showMessage('error', '‚ùå El archivo supera el tama√±o m√°ximo de 5MB');
        return;
      }

      // Validar extensi√≥n
      const validExtensions = ['.xlsx', '.xls'];
      const fileName = file.name.toLowerCase();
      const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
      
      if (!isValidExtension) {
        showMessage('error', '‚ùå Formato no v√°lido. Solo se permiten archivos .xlsx o .xls');
        return;
      }

      showMessage('info', '‚è≥ Leyendo archivo...');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet);

          excelData = jsonData;
          validateExcel(jsonData, file);
        } catch (error) {
          showMessage('error', '‚ùå Error al leer el archivo: ' + error.message);
        }
      };
      reader.readAsBinaryString(file);
    }

    function validateExcel(data, file) {
      const resultsCard = document.getElementById('resultsCard');
      const results = document.getElementById('results');
      resultsCard.style.display = 'block';
      results.innerHTML = '';

      // Estad√≠sticas
      const stats = document.createElement('div');
      stats.className = 'stats';
      stats.innerHTML = `
        <div class="stat-box">
          <div class="stat-number">${data.length}</div>
          <div class="stat-label">Filas detectadas</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${(file.size / 1024).toFixed(2)} KB</div>
          <div class="stat-label">Tama√±o del archivo</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${Object.keys(data[0] || {}).length}</div>
          <div class="stat-label">Columnas detectadas</div>
        </div>
      `;
      results.appendChild(stats);

      if (data.length === 0) {
        showMessage('error', '‚ùå El archivo est√° vac√≠o');
        return;
      }

      // Validar columnas
      const requiredColumns = ['CASA/APTO'];
      const optionalColumns = ['NOMBRE_RES', 'CC_RESIDENTE', 'CEL_RESIDENTE'];
      const allExpectedColumns = [...requiredColumns, ...optionalColumns];
      const actualColumns = Object.keys(data[0]);

      const columnsDiv = document.createElement('div');
      columnsDiv.innerHTML = '<h3 style="margin-top: 20px; margin-bottom: 10px;">Columnas detectadas:</h3>';
      const columnsContainer = document.createElement('div');
      columnsContainer.className = 'columns-detected';

      actualColumns.forEach(col => {
        const badge = document.createElement('span');
        badge.className = 'column-badge';
        badge.textContent = col;
        
        if (requiredColumns.includes(col)) {
          badge.classList.add('required');
          badge.title = 'Columna obligatoria ‚úì';
        }
        
        columnsContainer.appendChild(badge);
      });
      columnsDiv.appendChild(columnsContainer);
      results.appendChild(columnsDiv);

      // Verificar columnas requeridas
      const missingRequired = requiredColumns.filter(col => !actualColumns.includes(col));
      
      if (missingRequired.length > 0) {
        showMessage('error', `‚ùå Falta la columna obligatoria: ${missingRequired.join(', ')}`);
        
        const helpDiv = document.createElement('div');
        helpDiv.className = 'message warning';
        helpDiv.innerHTML = `
          <strong>‚ö†Ô∏è Columnas requeridas:</strong><br>
          ‚Ä¢ <code>CASA/APTO</code> - OBLIGATORIA<br>
          ‚Ä¢ <code>NOMBRE_RES</code> - Opcional<br>
          ‚Ä¢ <code>CC_RESIDENTE</code> - Opcional<br>
          ‚Ä¢ <code>CEL_RESIDENTE</code> - Opcional
        `;
        results.appendChild(helpDiv);
        return;
      }

      showMessage('success', '‚úÖ Estructura del archivo v√°lida');

      // Mostrar bot√≥n para subir al backend
      const uploadBackendBtn = document.createElement('button');
      uploadBackendBtn.className = 'upload-btn';
      uploadBackendBtn.style.marginTop = '20px';
      uploadBackendBtn.innerHTML = '<span class="loading" style="display: none;"></span> üöÄ Subir al Backend';
      uploadBackendBtn.onclick = uploadToBackend;
      results.appendChild(uploadBackendBtn);

      // Mostrar preview
      showDataPreview(data);
    }

    function showDataPreview(data) {
      const previewCard = document.getElementById('dataPreviewCard');
      const preview = document.getElementById('dataPreview');
      previewCard.style.display = 'block';

      const limitedData = data.slice(0, 10);
      
      let tableHTML = '<table class="data-table"><thead><tr>';
      const columns = Object.keys(data[0]);
      columns.forEach(col => {
        tableHTML += `<th>${col}</th>`;
      });
      tableHTML += '</tr></thead><tbody>';

      limitedData.forEach(row => {
        tableHTML += '<tr>';
        columns.forEach(col => {
          tableHTML += `<td>${row[col] || ''}</td>`;
        });
        tableHTML += '</tr>';
      });

      tableHTML += '</tbody></table>';

      if (data.length > 10) {
        tableHTML += `<p style="margin-top: 15px; color: #666; font-size: 13px;">Mostrando 10 de ${data.length} filas</p>`;
      }

      preview.innerHTML = tableHTML;
    }

    async function uploadToBackend() {
      const token = document.getElementById('tokenInput').value.trim();
      
      if (!token) {
        showMessage('warning', '‚ö†Ô∏è No se proporcion√≥ un token. Ingresa tu token para subir al backend.');
        return;
      }

      if (!currentFile) {
        showMessage('error', '‚ùå No hay archivo seleccionado');
        return;
      }

      const btn = event.target;
      const loading = btn.querySelector('.loading');
      loading.style.display = 'inline-block';
      btn.disabled = true;

      const formData = new FormData();
      formData.append('file', currentFile);

      try {
        const response = await axios.post('http://127.0.0.1:3000/house/excel', formData, {
          headers: {
            'Content-Type': 'multipart/form-data',
            'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`
          }
        });

        if (response.status === 201) {
          showMessage('success', `‚úÖ ¬°√âxito! Archivo cargado correctamente al backend. Se procesaron ${response.data.length} registros.`);
          console.log('Respuesta del backend:', response.data);
        }
      } catch (error) {
        console.error('Error:', error);
        
        if (error.response) {
          const status = error.response.status;
          const errorMsg = error.response.data?.message || 'Error desconocido';
          
          if (status === 400) {
            showMessage('error', `‚ùå Error 400: ${errorMsg}`);
          } else if (status === 401) {
            showMessage('error', '‚ùå Error 401: Token inv√°lido o no proporcionado');
          } else if (status === 403) {
            showMessage('error', '‚ùå Error 403: Permisos insuficientes');
          } else if (status === 500) {
            showMessage('error', `‚ùå Error 500: Error en el servidor - ${errorMsg}`);
          } else {
            showMessage('error', `‚ùå Error ${status}: ${errorMsg}`);
          }
        } else if (error.request) {
          showMessage('error', '‚ùå No se pudo conectar con el backend. Verifica que est√© corriendo en http://127.0.0.1:3000');
        } else {
          showMessage('error', `‚ùå Error: ${error.message}`);
        }
      } finally {
        loading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function showMessage(type, text) {
      const fileInfo = document.getElementById('fileInfo');
      fileInfo.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    function downloadTemplate() {
      const data = [
        {
          "CASA/APTO": "101",
          "NOMBRE_RES": "Juan P√©rez Garc√≠a",
          "CC_RESIDENTE": 1234567890,
          "CEL_RESIDENTE": 3001234567
        },
        {
          "CASA/APTO": "102",
          "NOMBRE_RES": "Mar√≠a L√≥pez Hern√°ndez",
          "CC_RESIDENTE": 9876543210,
          "CEL_RESIDENTE": 3109876543
        },
        {
          "CASA/APTO": "103",
          "NOMBRE_RES": "Carlos Rodr√≠guez",
          "CC_RESIDENTE": 5551234567,
          "CEL_RESIDENTE": 3205551234
        }
      ];

      const ws = XLSX.utils.json_to_sheet(data);
      const wscols = [
        {wch: 20},
        {wch: 30},
        {wch: 15},
        {wch: 15}
      ];
      ws['!cols'] = wscols;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Casas");
      XLSX.writeFile(wb, "Plantilla_Casas_Valida.xlsx");
      
      showMessage('success', '‚úÖ Plantilla descargada exitosamente');
    }
  </script>
</body>
</html>